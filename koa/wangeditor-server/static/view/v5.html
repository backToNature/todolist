<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>wangeditor</title>
    <link rel="stylesheet" href="./lib/wangEditor.css">
</head>
<body>
    <div id="div3"></div>
    <script src="./lib/wangEditor.js"></script>
    <script src="./lib/cos-js-sdk-v5.js"></script>
    <script>
        // 初始化富文本编辑器
        var E = window.wangEditor;
        var editor = new E('#div3');
        editor.customConfig.uploadImgServer = '/upload';
        editor.customConfig.debug = true;
        // 图片上传逻辑
        editor.customConfig.showLinkImg = false;
        editor.customConfig.withCredentials = true;

        

        // 请求用到的参数
        var Bucket = 'ght-1251580007';
        var Region = 'ap-shanghai';
        var protocol = location.protocol === 'https:' ? 'https:' : 'http:';
        var prefix = protocol + '//' + Bucket + '.cos.' + Region + '.myqcloud.com/';
        
        // 计算签名
        var getAuthorization = function (options, callback) {
            var method = (options.Method || 'get').toLowerCase();
            var key = options.Key || '';
            // var url = 'http://127.0.0.1:3000/sts-post-object' +
                var url = '/api/stspost' +
                '?method=' + method +
                '&pathname=' + encodeURIComponent('/') +
                '&key=' + encodeURIComponent(key);
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onload = function (e) {
                var data = JSON.parse(e.target.responseText);
                if (data.authorization === '') {

                }
                callback(null, {
                    Authorization: data.authorization,
                    XCosSecurityToken: data.sessionToken,
                });
            };
            xhr.onerror = function (e) {
                callback('获取签名出错');
            };
            xhr.send();
        };

        // 上传文件
        var uploadFile = function (file, callback) {
            var Key = 'dir/' + file.name; // 这里指定上传目录和文件名
            
            getAuthorization({Method: 'POST', Key: Key}, function (err, info) {
                var auth = info.Authorization;
                var XCosSecurityToken = info.XCosSecurityToken;
                var fd = new FormData();
                fd.append('key', Key);
                fd.append('Signature', auth);
                fd.append('insertOnly', 0);

                XCosSecurityToken && fd.append('x-cos-security-token', XCosSecurityToken);
                // fd.append('file', file);
                fd.append('op', 'upload');
                fd.append('filecontent', file);

                var url = prefix;
                var xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                xhr.onload = function () {
                    if (Math.floor(xhr.status / 100) === 2) {
                        var ETag = xhr.getResponseHeader('etag');
                        callback(null, {url: url, ETag: ETag});
                    } else {
                        callback('文件 ' + Key + ' 上传失败，状态码：' + xhr.status);
                    }
                };
                xhr.onerror = function () {
                    callback('文件 ' + Key + ' 上传失败，请检查是否没配置 CORS 跨域规则');
                };
                xhr.send(fd);

            });
        };

        // 监听表单提交
        // document.getElementById('submitBtn').onclick = function (e) {
        //     var file = document.getElementById('fileSelector').files[0];
        //     if (!file) {
        //         document.getElementById('msg').innerText = '未选择上传文件';
        //         return;
        //     }
        //     file && uploadFile(file, function (err, data) {
        //         console.log(err || data);
        //         document.getElementById('msg').innerText = err ? err : ('上传成功，ETag=' + data.ETag);
        //     });
        // };
        
        editor.customConfig.customUploadImg = function (files, insert) {
            uploadFile(files[0], function (err, data) {
                insert(imgUrl);
            });
            // insert(imgUrl)
        }
        
        editor.create();
    </script>
</body>
</html>